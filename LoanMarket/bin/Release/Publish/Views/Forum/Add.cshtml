
@{
    Layout = null;
}

<!DOCTYPE html>
<!-- saved from url=(0051)http://www.uxiangquan.cn/index/forum/addtopic.html# -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <title>发帖子</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <link rel="stylesheet" type="text/css" href="~/Content/Files/发帖子_files/weui.min.css">
    <link rel="stylesheet" type="text/css" href="~/Content/Files/发帖子_files/iconfont.css">
    <link rel="stylesheet" href="~/Content/Files/发帖子_files/style.css">
    <script>

var APP_PATH="/index",CONST_PUBLIC="/static",API_URL="/Api",GUID="";
var IS_APP=function(){
	return false}
    </script>
    <script type="text/javascript" src="~/Content/Files/发帖子_files/jquery-2.2.3.min.js"></script>
    <script type="text/javascript" src="~/Content/Files/发帖子_files/weui.min.js"></script>
    <script type="text/javascript" src="~/Content/Files/发帖子_files/jquery.func.js"></script>
    <script type="text/javascript" src="~/Content/Files/发帖子_files/jquery.fileupload.js"></script>
    <script>
	var num = 0;
	var $UPLOAD_URL="/index/file/upload.html";
	var $NOPIC="/static/system/images/nopic.png";
	$(function(){
		$.rendUploaderx = function(id){
			var that = $(id);
			$(id).fileupload({
				url: $UPLOAD_URL,
				dataType: 'json',
				add: function (e, data) {
					if(num >= 3){
						alerterr('最多上传9张照片');
						return false;
					}
					data.submit();
				},
				progressall:function(e, data){
					var progress = parseInt(data.loaded / data.total * 100, 10);
					console.log(progress);
				},
				done: function (e, data) {
					var $result = data.result;
					if($result.status == 1){
						var html = '<div class="item img" data-img="'+$result.info+'" style="background-image:url('+$result.info+')"><a href="javascript:;" class="del"><i class="iconfont icon-guanbi"></i></a><input type="hidden" name="images[]" value="'+$result.info+'"></div>';
						$("#uploaderFiles").append(html);
						num ++;
					}else{
						alerterr($result.info);
					}
				},
				progressall: function (e, data) {

				}
			});
		};

		$.rendUploaderx('#uploaderInput');
	});
    </script>
    @*<script type="text/javascript" src="~/Content/Files/发帖子_files/jquery.form.js"></script>*@
</head>
<body ontouchstart="" style="background-color: #fff;">
    <form method="post" action="~/Api/Forum" class="ajaxformx">
        <input type="hidden" id="gourl" value="/index/forum/dynamic.html">
        <header class="weui-bar weui-bar-header appheader">
            <div class="weui-bar-btnbox weui-bar-left">
                <a href="/Forum/Index" class="weui-bar-btn">取消</a>
            </div>
            <div class="weui-bar-title">发帖</div>
            <div class="weui-bar-btnbox weui-bar-right" style="right: 15px;">
                <button type="submit" class="weui-btn weui-btn_primary weui-btn_mini" style="padding: 0 10px;">发布</button>
            </div>
        </header>
        <div class="weui-content">
            <div class="weui-cells" style="margin-top: 0;">
                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label " name="Title">标题</label>
                    </div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" name="title" type="text" placeholder="请输入标题">
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <textarea class="weui-textarea" name="ContentBody" placeholder="请输入内容" rows="5"></textarea>
                    </div>
                </div>
                @*<div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="mt10">上传图片</div>
                        <div class="uploads">
                            <div id="uploaderFiles">

                            </div>
                            <div class="item">
                                <div class="icon"><i class="iconfont icon-xiangji"></i></div>
                                <div><input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*"></div>
                            </div>
                        </div>
                    </div>
                </div>*@
            </div>
        </div>
    </form>

    <div class="preview-image">
        <a href="javascript:;" class="closebtn"><i class="iconfont icon-guanbi"></i></a>
        <div class="swiper-container" id="imgswiper">
            <div class="swiper-wrapper">

            </div>
            <div class="swiper-pagination"></div>
        </div>
    </div>
    <script src="~/Content/Files/发帖子_files/swiper.min.js"></script>
    <link rel="stylesheet" href="~/Content/Files/发帖子_files/swiper.min.css">
    <script>
			var title = localStorage.title;
			if(title){
				$("input[name='title']").val(title);
			}
			var content = localStorage.content;
			if(content){
				$("textarea[name='content']").val(content);
			}
			var images = localStorage.images;
			if(images){
				images = localStorage.images.split(',');
				var html = '';
				for(var i = 0; i < images.length; i++){
					html += '<div class="item img" data-img="'+images[i]+'" style="background-image:url('+images[i]+')"><a href="javascript:;" class="del"><i class="iconfont icon-guanbi"></i></a><input type="hidden" name="images[]" value="'+images[i]+'"></div>';
				}
				$("#uploaderFiles").append(html);
			}

			$("#uploaderFiles").on("click", ".del", function(){
				$(this).parents(".img").remove();
				num --;
				return false;
			});

			$(".preview-image").on("click", ".closebtn", function() {
				$(this).parents(".preview-image").hide()
			});

			$("#uploaderFiles").on("click", ".img", function() {
				$(".preview-image").show();
				var imgs = "";
				for (var i = 0; i < $("#uploaderFiles .img").length; i++) {
					imgs += '<div class="swiper-slide"><div class="swiper-zoom-container"><img src="' + $("#uploaderFiles .img")
						.eq(i).data().img + '"></div></div>'

				}
				$(".preview-image .swiper-wrapper").html(imgs);
				var imgswiper = new Swiper('#imgswiper', {
					zoom: true,
					pagination: {
						el: '#imgswiper .swiper-pagination',
						type: 'fraction',
					},
					initialSlide: $(this).index(),
				})
			})

			pushHistory();
		    window.addEventListener("popstate", function (e) {
		    	var title = $("input[name='title']").val();
		    	var content = $("textarea[name='content']").val();
		    	var images = [];
				$("input[name='images[]']").each(function(){
					images.push($(this).val());
	     		})
	     		if(title || content || images.length > 0){
	     			weui.confirm('保留此次编辑？', {
					    title: '',
					    buttons: [{
					        label: '不保留',
					        type: 'default',
					        onClick: function(){
					        	localStorage.removeItem('title');
					        	localStorage.removeItem('content');
					        	localStorage.removeItem('images');
					        	history.back();
					        }
					    }, {
					        label: '保留',
					        type: 'primary',
					        onClick: function(){
					        	localStorage.title = title;
								localStorage.content = content;
								localStorage.images = images;
					        	history.back();
					        }
					    }]
					});
	     		}else{
	     			history.back();
	     		}
		    }, false);

		    function pushHistory() {
		        var state = {
		            title: "title",
		            url: "#"
		        };
		        window.history.pushState(state, "title", "#");
		    }
    </script>



</body>
</html>
